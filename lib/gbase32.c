#include "gbase32.h"


static const unsigned char mime_base32_rank[256] = {
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0xff,
    0xff, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e,
    0x0f, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
};

gsize
g_base32_decode_step(
    const gchar* in,
    gsize len,
    guchar* out,
    gint* state,
    guint64* save)
{
    const guchar* in_ptr;
    const guchar* in_end;
    guchar* out_ptr;
    guchar last[6] = {0x00};
    guchar c;
    guchar rank;
    guint64 v;
    gint i;
    
    g_return_val_if_fail(in != NULL || len == 0, 0);
    g_return_val_if_fail(out != NULL, 0);
    g_return_val_if_fail(state != NULL, 0);
    g_return_val_if_fail(save != NULL, 0);

    if (len == 0) {
        return 0;
    }

    in_end = (const guchar*) in + len;
    out_ptr = out;

    v = *save;
    i = *state;
    
    if (i < 0) {
        i = -i;
        last[0] = '=';
    }

    in_ptr = (const guchar*) in;
    while (in_ptr < in_end) {
        c = *in_ptr++;
        rank = mime_base32_rank[c];
        if (rank != 0xff) {
            last[5] = last[4];
            last[4] = last[3];
            last[3] = last[2];
            last[2] = last[1];
            last[1] = last[0];
            last[0] = c;
            v = (v << 5) | rank;
            i++;
            if (i == 8) {
                *out_ptr++ = v >> 32;
                if (last[5] != '=') {
                    *out_ptr++ = v >> 24;
                }
                if (last[3] != '=') {
                    *out_ptr++ = v >> 16;
                }
                if (last[2] != '=') {
                    *out_ptr++ = v >> 8;
                }
                if (last[0] != '=') {
                    *out_ptr++ = v;
                }
                i = 0;
            }
        }
    }
    *save = v;
    *state = last[0] == '=' ? -i : i;

    return out_ptr - out;
}

guchar*
g_base32_decode(
        const gchar* text,
        gsize* out_len)
{
    guchar* ret;
    gsize input_length;
    gint state = 0;
    guint64 save = 0;

    g_return_val_if_fail(text != NULL, NULL);
    g_return_val_if_fail(out_len != NULL, NULL);

    input_length = strlen(text);

    ret = g_malloc0((input_length / 8) * 5 + 1);
    *out_len = 
        g_base32_decode_step(text, input_length, ret, &state, &save);

    return ret;
}
